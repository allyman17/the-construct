# Create service account with necessary permissions
serviceAccount:
  create: true
  name: fluent-bit

rbac:
  create: true
  nodeAccess: true
  
# Configure Fluent Bit to connect to Elasticsearch with proper auth
config:
  service: |
    [SERVICE]
        Daemon Off
        Flush 1
        Log_Level info
        Parsers_File /fluent-bit/etc/parsers.conf
        Parsers_File /fluent-bit/etc/conf/custom_parsers.conf
        HTTP_Server On
        HTTP_Listen 0.0.0.0
        HTTP_Port 2020
        Health_Check On

  inputs: |
    [INPUT]
        Name tail
        Path /var/log/containers/*.log
        multiline.parser docker, cri
        Tag kube.*
        Mem_Buf_Limit 5MB
        Skip_Long_Lines On
        Exclude_Path /var/log/containers/*_kube-system_*.log,/var/log/containers/*_elasticsearch_*.log,/var/log/containers/*_fluent-bit_*.log

    [INPUT]
        Name systemd
        Tag host.*
        Systemd_Filter _SYSTEMD_UNIT=kubelet.service
        Read_From_Tail On

  filters: |
    [FILTER]
        Name kubernetes
        Match kube.*
        Merge_Log On
        Keep_Log Off
        K8S-Logging.Parser On
        K8S-Logging.Exclude On
        Labels On
        Annotations On

  outputs: |
    [OUTPUT]
        Name es
        Match kube.*
        Host elasticsearch-master.elasticsearch.svc.cluster.local
        Port 9200
        HTTP_User elastic
        HTTP_Passwd ${ELASTICSEARCH_PASSWORD}
        Logstash_Format On
        Logstash_Prefix kubernetes
        Retry_Limit 5
        tls Off
        tls.verify Off
        Suppress_Type_Name On

    [OUTPUT]
        Name es
        Match host.*
        Host elasticsearch-master.elasticsearch.svc.cluster.local
        Port 9200
        HTTP_User elastic
        HTTP_Passwd ${ELASTICSEARCH_PASSWORD}
        Logstash_Format On
        Logstash_Prefix node
        Retry_Limit 5
        tls Off
        tls.verify Off
        Suppress_Type_Name On

# Mount the Elasticsearch credentials secret
extraVolumes:
  - name: es-credentials
    secret:
      secretName: elasticsearch-master-credentials
      optional: false

extraVolumeMounts:
  - name: es-credentials
    mountPath: /etc/fluent-bit/secrets
    readOnly: true

env:
  - name: ELASTICSEARCH_PASSWORD
    valueFrom:
      secretKeyRef:
        name: elasticsearch-master-credentials
        key: password
        
# Ensure proper resource allocation
resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 256Mi